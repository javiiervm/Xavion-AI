<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xavion AI</title>
  <link rel="icon" type="image/png" href="/assets/logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
    
    /* Animated gradient background (Rich & Dark Logo Palette) */
    .animated-bg {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #020617 0%, #1e0a00 25%, #1e050a 50%, #0f021a 75%, #020617 100%);
      background-size: 400% 400%;
      animation: gradientShift 20s ease-in-out infinite;
      z-index: -1;
    }
    
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* Floating orbs (Visible luminosity) */
    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.3;
      animation: float 25s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    .orb-1 {
      width: 550px;
      height: 550px;
      background: radial-gradient(circle, #FF4060 0%, transparent 70%);
      top: -5%;
      left: -5%;
      animation-delay: 0s;
    }
    
    .orb-2 {
      width: 650px;
      height: 650px;
      background: radial-gradient(circle, #9900CC 0%, transparent 70%);
      top: 25%;
      right: -5%;
      animation-delay: -5s;
    }
    
    .orb-3 {
      width: 450px;
      height: 450px;
      background: radial-gradient(circle, #1d4ed8 0%, transparent 70%);
      bottom: -5%;
      left: 10%;
      animation-delay: -10s;
    }
    
    .orb-1 {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, #FF4060 0%, transparent 70%);
      top: -10%;
      left: -10%;
      animation-delay: 0s;
    }
    
    .orb-2 {
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, #9900CC 0%, transparent 70%);
      top: 30%;
      right: -5%;
      animation-delay: -7s;
    }
    
    .orb-3 {
      width: 450px;
      height: 450px;
      background: radial-gradient(circle, #002080 0%, transparent 70%);
      bottom: -10%;
      left: 15%;
      animation-delay: -14s;
    }
    
    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(40px, -40px) scale(1.1); }
      50% { transform: translate(-30px, 30px) scale(0.9); }
      75% { transform: translate(30px, 40px) scale(1.05); }
    }

    .gradient-bg { background: linear-gradient(180deg, #FF9F60 0%, #FF4060 35%, #FFB6C1 50%, #9900CC 65%, #002080 100%); }
    .gradient-text {
      background: linear-gradient(135deg, #FF9F60 0%, #FF4060 35%, #9900CC 65%, #002080 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      padding-bottom: 0.1em;
    }
    .message-gradient { background: rgba(255, 255, 255, 0.05); }
    .user-message-gradient { 
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }
    .glow-effect { box-shadow: 0 0 40px rgba(255, 255, 255, 0.02); }
    .input-glow:focus { box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1); }
    .send-btn {
      background: linear-gradient(135deg, #FF9F60 0%, #FF4060 50%, #9900CC 100%);
      background-size: 200% 200%;
      animation: gradientShift 3s ease infinite;
    }
    .send-btn:hover { background-size: 100% 100%; transform: scale(1.05); }
    @keyframes gradientShift { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message-animate { animation: fadeInUp 0.3s ease-out; }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }
    .typing-dot { animation: typing 1s ease-in-out infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }
    .scrollbar-custom::-webkit-scrollbar { width: 6px; }
    .scrollbar-custom::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 3px; }
    .scrollbar-custom::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
    
    /* Liquid Glass Effect (Refined for visibility) */
    .liquid-glass {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(30px) saturate(180%) brightness(100%);
      -webkit-backdrop-filter: blur(30px) saturate(180%) brightness(100%);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -1px 0 rgba(255, 255, 255, 0.05);
    }
    
    .liquid-glass-dark {
      background: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .liquid-glass-input {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px) saturate(160%);
      -webkit-backdrop-filter: blur(20px) saturate(160%);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 
        inset 0 2px 4px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .liquid-glass-button {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 
        0 4px 15px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .liquid-glass-button:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.1) 100%);
      box-shadow: 
        0 6px 20px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.4);
      transform: translateY(-2px) scale(1.02);
    }
    
    .liquid-glass-button:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    /* Message Bar Button Exceptions */
    .mic-btn-liquid {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      transition: all 0.3s ease !important;
      color: rgba(255, 255, 255, 0.6);
    }
    .mic-btn-liquid:hover {
      transform: none !important;
      background: rgba(255, 255, 255, 0.08) !important;
      color: white !important;
    }
    .mic-btn-liquid:active {
      transform: scale(0.9) !important;
    }

    .send-btn-liquid {
      transition: all 0.3s ease !important;
    }
    .send-btn-liquid:hover {
      transform: none !important;
      filter: brightness(1.15) saturate(110%);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.1) !important;
    }
    .send-btn-liquid:active {
      transform: scale(0.95) !important;
    }

    /* Shine effect */
    .glass-shine {
      position: relative;
      overflow: hidden;
    }
    
    .glass-shine::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg,
        transparent 40%,
        rgba(255, 255, 255, 0.1) 50%,
        transparent 60%
      );
      animation: shine 8s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes shine {
      0%, 100% { transform: translateX(-100%) rotate(45deg); }
      50% { transform: translateX(100%) rotate(45deg); }
    }

    .stop-shine::after {
      animation: none !important;
      opacity: 0 !important;
    }

    /* Message bubbles (Liquid) */
    .message-user-liquid {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.5) 0%, rgba(37, 99, 235, 0.5) 100%);
      backdrop-filter: blur(15px) saturate(180%);
      -webkit-backdrop-filter: blur(15px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
    }
    
    .message-ai-liquid {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    .mic-active {
      color: #FF4060 !important;
      animation: pulse 1.5s infinite;
    }
    .sidebar-item:hover { background: rgba(255, 255, 255, 0.05); }
    .sidebar-item.active { background: rgba(255, 255, 255, 0.1); border-left: 3px solid #FF4060; }

    /* Voice Mode Styles */
    .voice-mode-active #welcome-container,
    .voice-mode-active #input-area,
    .voice-mode-active #chat-container {
      display: none !important;
    }
    
    #voice-overlay {
      display: none;
    }
    
    .voice-mode-active #voice-overlay {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      animation: fadeInUp 0.5s ease-out;
    }

    .voice-bars {
      display: flex;
      align-items: center;
      gap: 3px;
      height: 20px;
    }
    .voice-bar {
      width: 3px;
      background-color: white;
      border-radius: 2px;
      height: 12px;
    }
    .voice-bar:nth-child(even) { height: 18px; }
    
    .voice-mode-btns:hover {
      transform: none !important;
    }

    .logo-pulse {
      animation: logoPulse 2s infinite ease-in-out;
    }
    @keyframes logoPulse {
      0%, 100% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(255, 64, 96, 0)); }
      50% { transform: scale(1.05); filter: drop-shadow(0 0 30px rgba(255, 64, 96, 0.3)); }
    }
  </style>
 </head>
 <body class="text-white overflow-hidden relative">
  <!-- Fixed Background Layer -->
  <div class="animated-bg"></div>
  
  <!-- Floating Orbs -->
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>

  <div class="fixed inset-0 flex z-10">
   <!-- Sidebar -->
   <aside id="sidebar" class="w-72 liquid-glass-dark border-r border-white/10 flex flex-col h-full shrink-0 transition-all duration-300 ease-in-out z-50" style="margin-left: -288px;">
    <div class="p-5 border-b border-white/10 flex items-center justify-between">
     <div class="flex items-center">
      <img src="/assets/logo_full.png" alt="Xavion AI" class="h-10 w-auto object-contain">
     </div>
     <button id="toggle-sidebar" class="p-2.5 rounded-lg liquid-glass-button text-slate-200">
      <svg id="toggle-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
     </button>
    </div>
    <div class="p-4">
      <button id="new-chat-btn" class="w-full py-3 px-4 rounded-xl liquid-glass-button text-white font-medium flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> New conversation
      </button>
    </div>
    <div id="chat-history-container" class="flex-1 overflow-y-auto scrollbar-custom px-3">
     <p class="text-xs text-white/50 uppercase tracking-wider px-3 mb-2">Recent Chats</p>
     <div id="chat-history-list" class="space-y-1">
      <!-- Dynamic history items will be injected here -->
     </div>
    </div>
   </aside>

   <!-- Toggle Button (visible when sidebar is closed) -->
   <button id="open-sidebar-btn" class="fixed left-4 top-4 p-2.5 rounded-lg liquid-glass-button text-white transition-all duration-300 opacity-100 pointer-events-auto" style="z-index: 40;">
    <svg class="w-5 h-5 text-slate-200" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
   </button>

   <!-- Main Chat Area -->
   <main class="flex-1 flex flex-col h-full bg-transparent overflow-hidden relative">
    
    <!-- Voice Conversation Overlay -->
    <div id="voice-overlay" class="hidden">
      <div class="text-center">
        <div class="w-80 h-80 mx-auto mb-12 logo-pulse">
          <img src="/assets/logo.png" alt="Xavion Logo" class="w-full h-full object-contain rounded-2xl">
        </div>
        <div class="flex items-center justify-center gap-6">
          <button id="mute-voice-btn" class="liquid-glass-button voice-mode-btns w-16 h-16 rounded-full flex items-center justify-center text-white transition-all">
            <svg id="mute-icon" class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
          </button>
          <button id="exit-voice-btn" class="voice-mode-btns bg-red-500/20 hover:bg-red-500/40 border border-red-500/50 w-16 h-16 rounded-full flex items-center justify-center text-white transition-all">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Welcome View -->
    <div id="welcome-container" class="flex-1 flex flex-col items-center justify-center px-4">
     <div class="text-center mb-12 welcome-content-box">
      <div class="w-72 h-72 mx-auto mb-2">
       <img src="/assets/logo.png" alt="Xavion Logo" class="w-full h-full object-contain rounded-2xl">
      </div>
      <h1 id="welcome-title" class="text-4xl font-bold gradient-text mb-3">How can I help you today?</h1>
     </div>
     <form id="chat-form-welcome" class="relative w-full max-w-2xl">
      <div class="relative liquid-glass-input rounded-[2rem] overflow-hidden glass-shine border border-white/20">
        <textarea id="message-input-welcome" rows="1" placeholder="Type your message..." class="w-full bg-transparent text-white placeholder-white/50 px-6 py-4 pr-28 resize-none focus:outline-none rounded-[2rem] text-base" style="max-height: 200px;"></textarea>
        <div class="absolute right-2 bottom-2 flex gap-2">
          <button type="button" id="mic-btn-welcome" class="mic-btn-liquid w-11 h-11 rounded-full flex items-center justify-center text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
          </button>
          <button type="submit" id="send-btn-welcome" class="send-btn-liquid liquid-glass-button w-11 h-11 rounded-full flex items-center justify-center shadow-lg border border-white/20">
            <div class="send-icon">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
            </div>
            <div class="voice-bars-icon hidden">
              <div class="voice-bars">
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
              </div>
            </div>
          </button>
        </div>
      </div>
     </form>
    </div>

    <!-- Chat Messages -->
    <div id="chat-container" class="flex-1 overflow-y-auto scrollbar-custom px-4 py-6 hidden">
     <div class="max-w-3xl mx-auto space-y-6">
      <div id="messages" class="space-y-6"></div>
     </div>
    </div>

    <!-- Input Area -->
    <div id="input-area" class="bg-transparent px-4 py-4 hidden">
     <div class="max-w-3xl mx-auto">
      <form id="chat-form" class="relative">
       <div class="relative liquid-glass-input rounded-[2rem] overflow-hidden glass-shine border border-white/20">
         <textarea id="message-input" rows="1" placeholder="Type your message..." class="w-full bg-transparent text-white placeholder-white/50 px-6 py-4 pr-28 resize-none focus:outline-none rounded-[2rem] text-base" style="max-height: 200px;"></textarea>
         <div class="absolute right-2 bottom-2 flex gap-2">
           <button type="button" id="mic-btn" class="mic-btn-liquid w-11 h-11 rounded-full flex items-center justify-center text-white">
             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
           </button>
           <button type="submit" id="send-btn" class="send-btn-liquid liquid-glass-button w-11 h-11 rounded-full flex items-center justify-center shadow-lg border border-white/20">
             <div class="send-icon">
               <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
             </div>
             <div class="voice-bars-icon hidden">
               <div class="voice-bars">
                 <div class="voice-bar"></div>
                 <div class="voice-bar"></div>
                 <div class="voice-bar"></div>
                 <div class="voice-bar"></div>
               </div>
             </div>
           </button>
         </div>
       </div>
      </form>
     </div>
    </div>
   </main>
  </div>

  <script>
    let conversationHistory = "";
    let chatStarted = false;
    let currentConversationId = null;

    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatFormWelcome = document.getElementById('chat-form-welcome');
    const messageInputWelcome = document.getElementById('message-input-welcome');
    const messagesContainer = document.getElementById('messages');
    const chatContainer = document.getElementById('chat-container');
    const inputArea = document.getElementById('input-area');
    const welcomeContainer = document.getElementById('welcome-container');
    const welcomeTitle = document.getElementById('welcome-title');
    const chatHistoryList = document.getElementById('chat-history-list');
    
    // Voice Mode Elements
    const voiceOverlay = document.getElementById('voice-overlay');
    const muteVoiceBtn = document.getElementById('mute-voice-btn');
    const exitVoiceBtn = document.getElementById('exit-voice-btn');
    const sendBtn = document.getElementById('send-btn');
    const sendBtnWelcome = document.getElementById('send-btn-welcome');
    
    let isVoiceMode = false;
    let isVoiceMuted = false;

    function updateSendButtonState(input) {
      const form = input.closest('form');
      const btn = form.querySelector('button[type="submit"]');
      const sendIcon = btn.querySelector('.send-icon');
      const voiceIcon = btn.querySelector('.voice-bars-icon');
      
      if (input.value.trim().length > 0) {
        sendIcon.classList.remove('hidden');
        voiceIcon.classList.add('hidden');
        btn.dataset.mode = 'send';
      } else {
        sendIcon.classList.add('hidden');
        voiceIcon.classList.remove('hidden');
        btn.dataset.mode = 'voice';
      }
    }

    function toggleVoiceMode(active) {
      isVoiceMode = active;
      if (active) {
        document.body.classList.add('voice-mode-active');
        // If we are in voice mode, we should probably start a specific recognition or interaction
        console.log("Voice Conversation Mode Activated");
      } else {
        document.body.classList.remove('voice-mode-active');
        console.log("Voice Conversation Mode Deactivated");
      }
    }

    muteVoiceBtn.addEventListener('click', () => {
      isVoiceMuted = !isVoiceMuted;
      const icon = muteVoiceBtn.querySelector('#mute-icon');
      if (isVoiceMuted) {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />';
        muteVoiceBtn.classList.add('bg-red-500/20');
      } else {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />';
        muteVoiceBtn.classList.remove('bg-red-500/20');
      }
    });

    exitVoiceBtn.addEventListener('click', () => {
      toggleVoiceMode(false);
    });

    const welcomeMessages = [
      "How can I help you today?",
      "What's on your mind?",
      "Need help with something?",
      "Let's build something amazing.",
      "Ready to assist you!",
      "What can I do for you today?",
      "Ask me anything!"
    ];

    function setRandomWelcomeMessage() {
      const randomIndex = Math.floor(Math.random() * welcomeMessages.length);
      welcomeTitle.textContent = welcomeMessages[randomIndex];
    }

    // Set initial welcome message
    setRandomWelcomeMessage();

    async function loadChatHistory() {
      try {
        const response = await fetch('/conversations');
        const conversations = await response.json();
        
        chatHistoryList.innerHTML = '';
        conversations.forEach(conv => {
          const item = document.createElement('div');
          const isActive = conv.id === currentConversationId;
          item.className = `sidebar-item group relative ${isActive ? 'active' : ''} rounded-lg px-3 py-3 cursor-pointer transition-all duration-200`;
          
          // Format time
          const date = new Date(conv.last_interaction * 1000);
          const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const isToday = new Date().toDateString() === date.toDateString();
          const displayDate = isToday ? timeStr : date.toLocaleDateString();

          item.innerHTML = `
            <div class="flex flex-col pr-8" onclick="loadConversation('${conv.id}')">
              <p class="text-sm ${isActive ? 'text-slate-200' : 'text-slate-400'} truncate font-medium title-text">${conv.title}</p>
              <p class="text-xs text-slate-500 mt-1">${displayDate}</p>
            </div>
            <div class="absolute right-2 top-1/2 -translate-y-1/2 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
              <button onclick="event.stopPropagation(); renameConversation('${conv.id}', '${conv.title.replace(/'/g, "\\'")}')" class="p-1 hover:text-white text-slate-500" title="Rename">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
              </button>
              <button onclick="event.stopPropagation(); deleteConversation('${conv.id}')" class="p-1 hover:text-red-400 text-slate-500" title="Delete">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
              </button>
            </div>
          `;
          
          chatHistoryList.appendChild(item);
        });
      } catch (error) {
        console.error("Error loading history:", error);
      }
    }

    async function deleteConversation(id) {
      if (!confirm("Are you sure you want to delete this conversation?")) return;
      
      try {
        const response = await fetch(`/conversations/${id}`, { method: 'DELETE' });
        if (response.ok) {
          if (currentConversationId === id) {
            document.getElementById('new-chat-btn').click();
          } else {
            loadChatHistory();
          }
        }
      } catch (error) {
        console.error("Error deleting conversation:", error);
      }
    }

    async function renameConversation(id, currentTitle) {
      const newTitle = prompt("Enter new title:", currentTitle);
      if (!newTitle || newTitle === currentTitle) return;
      
      try {
        const response = await fetch(`/conversations/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: newTitle })
        });
        if (response.ok) {
          loadChatHistory();
        }
      } catch (error) {
        console.error("Error renaming conversation:", error);
      }
    }

    async function loadConversation(id) {
      try {
        const response = await fetch(`/conversations/${id}`);
        const data = await response.json();
        
        currentConversationId = id;
        conversationHistory = data.history;
        chatStarted = true;
        
        // UI updates
        welcomeContainer.classList.add('hidden');
        chatContainer.classList.remove('hidden');
        inputArea.classList.remove('hidden');
        messagesContainer.innerHTML = '';
        
        data.messages.forEach(msg => {
          addMessage(msg.role, msg.content);
        });
        
        loadChatHistory(); // Update active state in sidebar
        scrollToBottom();
      } catch (error) {
        console.error("Error loading conversation:", error);
      }
    }

    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
    }

    [messageInput, messageInputWelcome].forEach(input => {
      // Initialize state
      updateSendButtonState(input);
      
      input.addEventListener('input', function() { 
        autoResizeTextarea(this); 
        updateSendButtonState(this);
        // Stop shine if there is text
        const container = this.closest('.glass-shine');
        if (container) {
          if (this.value.trim().length > 0) {
            container.classList.add('stop-shine');
          } else {
            // Only remove if not dictating (will be handled by voice logic too)
            if (!container.classList.contains('mic-dictating')) {
              container.classList.remove('stop-shine');
            }
          }
        }
      });
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.closest('form').dispatchEvent(new Event('submit'));
        }
      });
    });

    let activeRecognitions = [];

    function stopAllSpeechRecognition() {
      activeRecognitions.forEach(item => {
        if (item.isListening) {
          item.recognition.stop();
        }
      });
    }

    async function sendMessage(text) {
      if (!text) return;
      
      stopAllSpeechRecognition();

      if (!chatStarted) {
        chatStarted = true;
        welcomeContainer.classList.add('hidden');
        chatContainer.classList.remove('hidden');
        inputArea.classList.remove('hidden');
      }

      addMessage('user', text);
      messageInput.value = '';
      messageInputWelcome.value = '';
      messageInput.style.height = 'auto';
      
      // Restore shine
      document.querySelectorAll('.glass-shine').forEach(el => {
        el.classList.remove('stop-shine');
        el.classList.remove('mic-dictating');
      });
      
      updateSendButtonState(messageInput);
      updateSendButtonState(messageInputWelcome);
      
      const aiMessageDiv = addMessage('assistant', '');
      const aiContentPara = aiMessageDiv.querySelector('.content-para');
      showTypingIndicator(aiMessageDiv);

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: text,
            history: conversationHistory,
            debug: false,
            conversation_id: currentConversationId
          })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = "";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          
          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = JSON.parse(line.slice(6));
              if (data.token) {
                hideTypingIndicator(aiMessageDiv);
                fullResponse += data.token;
                aiContentPara.textContent = fullResponse;
                chatContainer.scrollTop = chatContainer.scrollHeight;
              } else if (data.done) {
                conversationHistory = data.history;
                currentConversationId = data.conversation_id;
                loadChatHistory(); // Refresh sidebar
              }
            }
          }
        }
      } catch (error) {
        console.error("Error:", error);
        hideTypingIndicator(aiMessageDiv);
        aiContentPara.textContent = "Error connecting to the server.";
      }
    }

    chatForm.addEventListener('submit', e => { 
      e.preventDefault(); 
      const btn = chatForm.querySelector('button[type="submit"]');
      if (btn.dataset.mode === 'voice') {
        toggleVoiceMode(true);
      } else {
        sendMessage(messageInput.value.trim()); 
      }
    });
    
    chatFormWelcome.addEventListener('submit', e => { 
      e.preventDefault(); 
      const btn = chatFormWelcome.querySelector('button[type="submit"]');
      if (btn.dataset.mode === 'voice') {
        toggleVoiceMode(true);
      } else {
        sendMessage(messageInputWelcome.value.trim()); 
      }
    });

    function addMessage(role, content) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex gap-4 message-animate ${role === 'user' ? 'flex-row-reverse' : ''}`;
      
      const avatar = role === 'user' 
        ? `<div class="w-9 h-9 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shrink-0 shadow-lg border border-white/20">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
           </div>`
        : `<div class="w-11 h-11 flex items-center justify-center shrink-0">
            <img src="/assets/logo.png" alt="Xavion" class="w-full h-full object-contain rounded-lg">
           </div>`;
      
      const bubbleClass = role === 'user' ? 'message-user-liquid text-white' : 'message-ai-liquid text-slate-100';
      
      messageDiv.innerHTML = `
        ${avatar}
        <div class="max-w-[80%] ${bubbleClass} rounded-2xl px-5 py-3 shadow-lg border border-white/10">
          <p class="content-para text-sm leading-relaxed whitespace-pre-wrap">${content}</p>
          <div class="typing-placeholder hidden mt-2">
            <div class="flex gap-1.5">
              <div class="w-1.5 h-1.5 rounded-full bg-violet-400 typing-dot"></div>
              <div class="w-1.5 h-1.5 rounded-full bg-pink-400 typing-dot"></div>
              <div class="w-1.5 h-1.5 rounded-full bg-orange-400 typing-dot"></div>
            </div>
          </div>
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return messageDiv;
    }

    function showTypingIndicator(messageDiv) {
      const indicator = messageDiv.querySelector('.typing-placeholder');
      indicator.classList.remove('hidden');
      
      // Also ensure the avatar is the logo if it's the first message
      const avatarContainer = messageDiv.querySelector('.shrink-0');
      if (avatarContainer && !avatarContainer.querySelector('img')) {
          avatarContainer.innerHTML = `<img src="/assets/logo.png" alt="Xavion" class="w-full h-full object-contain rounded-lg">`;
          avatarContainer.className = "w-11 h-11 flex items-center justify-center shrink-0";
      }
    }

    function hideTypingIndicator(messageDiv) {
      messageDiv.querySelector('.typing-placeholder').classList.add('hidden');
    }

    // Sidebar Logic
    let sidebarOpen = false;
    const toggleBtn = document.getElementById('toggle-sidebar');
    const openBtn = document.getElementById('open-sidebar-btn');
    const sidebar = document.getElementById('sidebar');
    const toggleIcon = document.getElementById('toggle-icon');

    function updateSidebarState() {
      if (sidebarOpen) {
        sidebar.style.marginLeft = '0';
        toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>';
        openBtn.style.opacity = '0';
        openBtn.style.pointerEvents = 'none';
      } else {
        sidebar.style.marginLeft = '-288px';
        toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>';
        openBtn.style.opacity = '1';
        openBtn.style.pointerEvents = 'auto';
      }
    }

    // Voice Dictation Logic
    function setupVoiceDictation(btnId, inputId) {
      const btn = document.getElementById(btnId);
      const input = document.getElementById(inputId);
      const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!Recognition) {
        btn.style.display = 'none';
        return;
      }

      const recognition = new Recognition();
      // Spanish with support for English terms in many engines
      recognition.lang = 'es-ES'; 
      recognition.continuous = true;
      recognition.interimResults = true;

      let state = {
        recognition: recognition,
        isListening: false,
        btn: btn
      };
      activeRecognitions.push(state);

      btn.addEventListener('click', () => {
        if (state.isListening) {
          recognition.stop();
        } else {
          recognition.start();
        }
      });

      recognition.onstart = () => {
        state.isListening = true;
        btn.classList.add('mic-active');
        const container = input.closest('.glass-shine');
        if (container) {
          container.classList.add('stop-shine');
          container.classList.add('mic-dictating');
        }
      };

      recognition.onend = () => {
        state.isListening = false;
        btn.classList.remove('mic-active');
        const container = input.closest('.glass-shine');
        if (container) {
          container.classList.remove('mic-dictating');
          // If input is empty, restore shine
          if (input.value.trim().length === 0) {
            container.classList.remove('stop-shine');
          }
        }
      };

      recognition.onresult = (event) => {
        let interim_transcript = '';
        let final_transcript = '';

        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            final_transcript += event.results[i][0].transcript;
          } else {
            interim_transcript += event.results[i][0].transcript;
          }
        }

        if (final_transcript) {
          const currentPos = input.selectionStart;
          const textBefore = input.value.substring(0, currentPos);
          const textAfter = input.value.substring(currentPos);
          
          input.value = textBefore + (textBefore && !textBefore.endsWith(' ') ? ' ' : '') + final_transcript + textAfter;
          autoResizeTextarea(input);
        }
      };

      recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
        if (event.error === 'no-speech') return;
        state.isListening = false;
        btn.classList.remove('mic-active');
      };
    }

    setupVoiceDictation('mic-btn-welcome', 'message-input-welcome');
    setupVoiceDictation('mic-btn', 'message-input');

    // Initialize state
    updateSidebarState();
    loadChatHistory();

    toggleBtn.addEventListener('click', () => { sidebarOpen = !sidebarOpen; updateSidebarState(); });
    openBtn.addEventListener('click', () => { sidebarOpen = true; updateSidebarState(); });

    document.getElementById('new-chat-btn').addEventListener('click', () => {
      conversationHistory = "";
      currentConversationId = null;
      messagesContainer.innerHTML = '';
      chatStarted = false;
      setRandomWelcomeMessage();
      loadChatHistory();
      welcomeContainer.classList.remove('hidden');
      chatContainer.classList.add('hidden');
      inputArea.classList.add('hidden');
    });
  </script>
 </body>
</html>
