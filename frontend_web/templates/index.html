<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xavion AI</title>
  <link rel="icon" type="image/png" href="/assets/logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
    
    /* Animated gradient background */
    .animated-bg {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #020617 0%, #1e0a00 25%, #1e050a 50%, #0f021a 75%, #020617 100%);
      background-size: 400% 400%;
      animation: gradientShift 20s ease-in-out infinite;
      z-index: -1;
    }
    
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* Floating orbs */
    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.3;
      animation: float 25s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    .orb-1 {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, #FF4060 0%, transparent 70%);
      top: -10%;
      left: -10%;
      animation-delay: 0s;
    }
    
    .orb-2 {
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, #9900CC 0%, transparent 70%);
      top: 30%;
      right: -5%;
      animation-delay: -7s;
    }
    
    .orb-3 {
      width: 450px;
      height: 450px;
      background: radial-gradient(circle, #002080 0%, transparent 70%);
      bottom: -10%;
      left: 15%;
      animation-delay: -14s;
    }
    
    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(40px, -40px) scale(1.1); }
      50% { transform: translate(-30px, 30px) scale(0.9); }
      75% { transform: translate(30px, 40px) scale(1.05); }
    }

    .gradient-text {
      background: linear-gradient(135deg, #FF9F60 0%, #FF4060 35%, #9900CC 65%, #002080 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      padding-bottom: 0.1em;
    }

    .liquid-glass-dark {
      background: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .liquid-glass-input {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px) saturate(160%);
      -webkit-backdrop-filter: blur(20px) saturate(160%);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 
        inset 0 2px 4px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .liquid-glass-button {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
      backdrop-filter: blur(12px) saturate(180%);
      -webkit-backdrop-filter: blur(12px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: 
        0 4px 15px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .liquid-glass-button:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.1) 100%);
    }

    .mic-btn-liquid {
      background: transparent !important;
      border: none !important;
      transition: all 0.3s ease !important;
      color: rgba(255, 255, 255, 0.6);
    }
    .mic-btn-liquid:hover {
      background: rgba(255, 255, 255, 0.08) !important;
      color: white !important;
    }

    .send-btn-liquid { transition: all 0.3s ease !important; }
    .send-btn-liquid:hover { filter: brightness(1.15) saturate(110%); }

    /* Glass shine */
    .glass-shine { position: relative; overflow: hidden; }
    .glass-shine::after {
      content: '';
      position: absolute;
      top: -50%; left: -50%; width: 200%; height: 200%;
      background: linear-gradient(45deg, transparent 40%, rgba(255, 255, 255, 0.1) 50%, transparent 60%);
      animation: shine 8s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes shine { 0%, 100% { transform: translateX(-100%) rotate(45deg); } 50% { transform: translateX(100%) rotate(45deg); } }
    .stop-shine::after { animation: none !important; opacity: 0 !important; }

    /* Message bubbles */
    .message-user-liquid {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.5) 0%, rgba(37, 99, 235, 0.5) 100%);
      backdrop-filter: blur(15px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.25);
    }
    .message-ai-liquid {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Typing indicator */
    .typing-dot {
      width: 4px; height: 4px; background-color: rgba(255,255,255,0.6); border-radius: 50%;
      animation: typing-bounce 1.4s infinite ease-in-out both;
    }
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing-bounce {
      0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
      40% { transform: scale(1.5); opacity: 1; }
    }

    @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
    .mic-active { color: #FF4060 !important; animation: pulse 1.5s infinite; }
    .sidebar-item:hover { background: rgba(255, 255, 255, 0.05); }
    .sidebar-item.active { background: rgba(255, 255, 255, 0.1); border-left: 3px solid #FF4060; }

    /* Voice Mode Styles */
    .voice-mode-active #welcome-container,
    .voice-mode-active #input-area,
    .voice-mode-active #chat-container { display: none !important; }
    
    #voice-overlay { display: none; }
    .voice-mode-active #voice-overlay {
      display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; animation: fadeInUp 0.5s ease-out;
    }

    .voice-bars { display: flex; align-items: center; gap: 3px; height: 20px; }
    .voice-bar { width: 3px; background-color: white; border-radius: 2px; height: 12px; }
    .voice-bar:nth-child(even) { height: 18px; }

    /* Visualizer Bars */
    .v-bar { transition: height 0.1s ease; }
    .logo-visualizer { transition: transform 0.1s ease, filter 0.1s ease; }

    @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 0.3; } 100% { transform: scale(0.8); opacity: 0.5; } }
    .pulse-ring {
      position: absolute; width: 100%; height: 100%; border-radius: 50%;
      background: radial-gradient(circle, #FF4060 0%, transparent 70%); z-index: -1; display: none;
    }
    .voice-mode-active .pulse-ring { display: block; animation: pulse-ring 2s infinite ease-in-out; }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message-animate { animation: fadeInUp 0.3s ease-out; }
    
    .scrollbar-custom::-webkit-scrollbar { width: 6px; }
    .scrollbar-custom::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
    .scrollbar-custom::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
  </style>
 </head>
 <body class="text-white overflow-hidden relative">
  <div class="animated-bg"></div>
  <div class="orb orb-1"></div><div class="orb orb-2"></div><div class="orb orb-3"></div>

  <div class="fixed inset-0 flex z-10">
   <aside id="sidebar" class="w-72 liquid-glass-dark border-r border-white/10 flex flex-col h-full shrink-0 transition-all duration-300 ease-in-out z-50" style="margin-left: -288px;">
    <div class="p-5 border-b border-white/10 flex items-center justify-between">
     <div class="flex items-center"><img src="/assets/logo_full.png" alt="Xavion AI" class="h-10 w-auto"></div>
     <button id="toggle-sidebar" class="p-2.5 rounded-lg liquid-glass-button text-slate-200">
      <svg id="toggle-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2"/></svg>
     </button>
    </div>
    <div class="p-4">
      <button id="new-chat-btn" class="w-full py-3 px-4 rounded-xl liquid-glass-button text-white font-medium flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2"/></svg> New conversation
      </button>
    </div>
    <div id="chat-history-container" class="flex-1 overflow-y-auto scrollbar-custom px-3">
     <p class="text-xs text-white/50 uppercase tracking-wider px-3 mb-2">Recent Chats</p>
     <div id="chat-history-list" class="space-y-1"></div>
    </div>
   </aside>

   <button id="open-sidebar-btn" class="fixed left-4 top-4 p-2.5 rounded-lg liquid-glass-button text-white z-40 transition-all duration-300 opacity-100">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2"/></svg>
   </button>

   <main class="flex-1 flex flex-col h-full bg-transparent overflow-hidden relative">
    <!-- Voice Overlay -->
    <div id="voice-overlay" class="hidden">
      <div class="text-center">
        <div class="w-80 h-80 mx-auto mb-12 relative">
          <div class="pulse-ring"></div>
          <div class="logo-visualizer w-full h-full">
            <img src="/assets/logo.png" alt="Xavion Logo" class="w-full h-full object-contain rounded-2xl">
          </div>
        </div>
        <!-- Mic Bars -->
        <div id="mic-activity-bars" class="flex items-center justify-center gap-2 mb-12 h-16">
            <div class="v-bar bg-white/40 w-1.5 rounded-full h-4"></div>
            <div class="v-bar bg-white/60 w-1.5 rounded-full h-8"></div>
            <div class="v-bar bg-white/80 w-1.5 rounded-full h-12"></div>
            <div class="v-bar bg-white/60 w-1.5 rounded-full h-8"></div>
            <div class="v-bar bg-white/40 w-1.5 rounded-full h-4"></div>
        </div>
        <div class="flex items-center justify-center gap-6">
          <button id="mute-voice-btn" class="liquid-glass-button w-16 h-16 rounded-full flex items-center justify-center text-white">
            <svg id="mute-icon" class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" stroke-width="2"/></svg>
          </button>
          <button id="exit-voice-btn" class="bg-red-500/20 hover:bg-red-500/40 border border-red-500/50 w-16 h-16 rounded-full flex items-center justify-center text-white">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2"/></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Welcome View -->
    <div id="welcome-container" class="flex-1 flex flex-col items-center justify-center px-4">
     <div class="text-center mb-12">
      <div class="w-72 h-72 mx-auto mb-2"><img src="/assets/logo.png" alt="Xavion" class="w-full h-full object-contain rounded-2xl"></div>
      <h1 id="welcome-title" class="text-4xl font-bold gradient-text mb-3">How can I help you today?</h1>
     </div>
     <form id="chat-form-welcome" class="relative w-full max-w-2xl">
      <div class="relative liquid-glass-input rounded-[2rem] glass-shine border border-white/20">
        <textarea id="message-input-welcome" rows="1" placeholder="Type your message..." class="w-full bg-transparent text-white placeholder-white/50 px-6 py-4 pr-28 resize-none focus:outline-none rounded-[2rem] text-base" style="max-height: 200px;"></textarea>
        <div class="absolute right-2 bottom-2 flex gap-2">
          <button type="button" id="mic-btn-welcome" class="mic-btn-liquid w-11 h-11 rounded-full flex items-center justify-center text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" stroke-width="2"/></svg>
          </button>
          <button type="submit" id="main-action-btn-welcome" class="send-btn-liquid liquid-glass-button w-11 h-11 rounded-full flex items-center justify-center">
            <!-- Content dynamic via JS -->
          </button>
        </div>
      </div>
     </form>
    </div>

    <!-- Chat Messages -->
    <div id="chat-container" class="flex-1 overflow-y-auto scrollbar-custom px-4 py-6 hidden">
     <div class="max-w-3xl mx-auto space-y-6"><div id="messages" class="space-y-6"></div></div>
    </div>

    <!-- Input Area -->
    <div id="input-area" class="bg-transparent px-4 py-4 hidden">
     <div class="max-w-3xl mx-auto">
      <form id="chat-form" class="relative">
       <div class="relative liquid-glass-input rounded-[2rem] glass-shine border border-white/20">
         <textarea id="message-input" rows="1" placeholder="Type your message..." class="w-full bg-transparent text-white placeholder-white/50 px-6 py-4 pr-28 resize-none focus:outline-none rounded-[2rem] text-base" style="max-height: 200px;"></textarea>
         <div class="absolute right-2 bottom-2 flex gap-2">
           <button type="button" id="mic-btn" class="mic-btn-liquid w-11 h-11 rounded-full flex items-center justify-center text-white">
             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" stroke-width="2"/></svg>
           </button>
           <button type="submit" id="main-action-btn" class="send-btn-liquid liquid-glass-button w-11 h-11 rounded-full flex items-center justify-center">
             <!-- Content dynamic via JS -->
           </button>
         </div>
       </div>
      </form>
     </div>
    </div>
   </main>
  </div>

  <script>
    let conversationHistory = "";
    let chatStarted = false;
    let currentConversationId = null;

    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatFormWelcome = document.getElementById('chat-form-welcome');
    const messageInputWelcome = document.getElementById('message-input-welcome');
    const messagesContainer = document.getElementById('messages');
    const chatContainer = document.getElementById('chat-container');
    const inputArea = document.getElementById('input-area');
    const welcomeContainer = document.getElementById('welcome-container');
    const welcomeTitle = document.getElementById('welcome-title');
    const chatHistoryList = document.getElementById('chat-history-list');
    
    // Icons
    const voiceIcon = `<div class="voice-bars"><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div></div>`;
    const sendIcon = `<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 7l5 5m0 0l-5 5m5-5H6" stroke-width="2"/></svg>`;

    function updateButtonState(input, btnId) {
      const btn = document.getElementById(btnId);
      if (input.value.trim().length > 0) {
        btn.innerHTML = sendIcon;
        btn.dataset.mode = 'send';
      } else {
        btn.innerHTML = voiceIcon;
        btn.dataset.mode = 'voice';
      }
    }

    // Voice Mode
    const voiceOverlay = document.getElementById('voice-overlay');
    const muteVoiceBtn = document.getElementById('mute-voice-btn');
    const exitVoiceBtn = document.getElementById('exit-voice-btn');
    
    let isVoiceMode = false;
    let isVoiceMuted = false;
    let voiceRecognition = null;
    let aiAudio = new Audio();
    
    // Web Audio API for visualizers
    let audioCtx = null;
    let micAnalyser = null;
    let aiAnalyser = null;
    let micStream = null;
    let animationId = null;

    function initAudioContext() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        aiAnalyser = audioCtx.createAnalyser();
        aiAnalyser.fftSize = 64;
        const aiSource = audioCtx.createMediaElementSource(aiAudio);
        aiSource.connect(aiAnalyser);
        aiAnalyser.connect(audioCtx.destination);
      }
    }

    function updateVisualizers() {
      if (!isVoiceMode) return;
      const bars = document.querySelectorAll('.v-bar');
      const logo = document.querySelector('.logo-visualizer');
      
      if (micAnalyser && !aiAudio.playing) {
        const dataArray = new Uint8Array(micAnalyser.frequencyBinCount);
        micAnalyser.getByteFrequencyData(dataArray);
        bars.forEach((bar, i) => {
          const val = dataArray[Math.floor(i * dataArray.length/bars.length)] / 255;
          bar.style.height = `${4 + val * 60}px`;
          bar.style.backgroundColor = `rgba(255,255,255,${0.4 + val*0.6})`;
        });
      } else {
        bars.forEach(bar => { bar.style.height = '8px'; bar.style.backgroundColor = 'rgba(255,255,255,0.3)'; });
      }
      
      if (aiAnalyser && aiAudio.playing) {
        const dataArray = new Uint8Array(aiAnalyser.frequencyBinCount);
        aiAnalyser.getByteFrequencyData(dataArray);
        let sum = 0; for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
        const avg = sum / dataArray.length;
        const scale = 1 + (avg/255)*0.4;
        const glow = (avg/255)*40;
        logo.style.transform = `scale(${scale})`;
        logo.style.filter = `drop-shadow(0 0 ${glow}px rgba(255, 64, 96, 0.6))`;
      } else {
        logo.style.transform = 'scale(1)'; logo.style.filter = 'none';
      }
      animationId = requestAnimationFrame(updateVisualizers);
    }

    async function setupMicAnalyser() {
      try {
        if (!micStream) {
          micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const micSource = audioCtx.createMediaStreamSource(micStream);
          micAnalyser = audioCtx.createAnalyser();
          micAnalyser.fftSize = 32;
          micSource.connect(micAnalyser);
        }
      } catch (e) { console.error("Mic error:", e); }
    }

    function toggleVoiceMode(active) {
      initAudioContext();
      isVoiceMode = active;
      if (active) {
        document.body.classList.add('voice-mode-active');
        voiceOverlay.classList.remove('hidden');
        startVoiceConversation();
        updateVisualizers();
        setupMicAnalyser();
      } else {
        document.body.classList.remove('voice-mode-active');
        voiceOverlay.classList.add('hidden');
        stopVoiceConversation();
        if (animationId) cancelAnimationFrame(animationId);
      }
    }

    function startVoiceConversation() {
      if (voiceRecognition) return;
      const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!Recognition) { alert("Navegador incompatible."); toggleVoiceMode(false); return; }
      voiceRecognition = new Recognition();
      voiceRecognition.lang = 'es-ES';
      voiceRecognition.continuous = false;
      voiceRecognition.onresult = async (e) => {
        const text = e.results[0][0].transcript;
        if (text.trim() && !isVoiceMuted) await processVoiceInteraction(text);
        else if (isVoiceMode) voiceRecognition.start();
      };
      voiceRecognition.onend = () => { if (isVoiceMode && !aiAudio.playing) voiceRecognition.start(); };
      voiceRecognition.onerror = (e) => { if(isVoiceMode && !aiAudio.playing) setTimeout(() => voiceRecognition.start(), 1000); };
      voiceRecognition.start();
    }

    function stopVoiceConversation() {
      if (voiceRecognition) { voiceRecognition.stop(); voiceRecognition = null; }
      aiAudio.pause(); aiAudio.src = ""; audioQueue = []; isPlayingAudio = false;
    }

    Object.defineProperty(Audio.prototype, 'playing', { get: function(){ return !!(this.currentTime > 0 && !this.paused && !this.ended && this.readyState > 2); } });

    let audioQueue = []; let isPlayingAudio = false;
    async function playNextInQueue() {
      if (audioQueue.length === 0) { isPlayingAudio = false; if (isVoiceMode && !aiAudio.playing) try { voiceRecognition.start(); } catch(e){} return; }
      isPlayingAudio = true;
      const cleanText = audioQueue.shift().replace(/[*#`]/g, "").trim();
      if (!cleanText) { playNextInQueue(); return; }
      aiAudio.src = `/tts_binary?text=${encodeURIComponent(cleanText)}`;
      aiAudio.onended = () => playNextInQueue();
      try { await aiAudio.play(); } catch(e) { playNextInQueue(); }
    }

    async function processVoiceInteraction(text) {
      audioQueue = [];
      try {
        const response = await fetch('/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: text, history: conversationHistory, conversation_id: currentConversationId }) });
        const reader = response.body.getReader(); const decoder = new TextDecoder();
        let currentSentence = "";
        while (true) {
          const { value, done } = await reader.read(); if (done) break;
          const lines = decoder.decode(value).split('\n');
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = JSON.parse(line.slice(6));
              if (data.token) {
                currentSentence += data.token;
                if (/[.!?\n]/.test(data.token) && currentSentence.trim().length > 10) { audioQueue.push(currentSentence.trim()); if(!isPlayingAudio) playNextInQueue(); currentSentence = ""; }
              }
              if (data.done) { conversationHistory = data.history; currentConversationId = data.conversation_id; if (currentSentence.trim()) { audioQueue.push(currentSentence.trim()); if(!isPlayingAudio) playNextInQueue(); } }
            }
          }
        }
      } catch (e) { if (isVoiceMode) voiceRecognition.start(); }
    }

    // UI Events
    exitVoiceBtn.addEventListener('click', () => toggleVoiceMode(false));
    muteVoiceBtn.addEventListener('click', () => {
      isVoiceMuted = !isVoiceMuted;
      muteVoiceBtn.querySelector('#mute-icon').innerHTML = isVoiceMuted ? '<path d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" stroke-width="2"/>' : '<path d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" stroke-width="2"/>';
      muteVoiceBtn.classList.toggle('bg-red-500/20', isVoiceMuted);
    });

    // Chat History & Messages
    async function loadChatHistory() {
      try {
        const response = await fetch('/conversations'); const conversations = await response.json();
        chatHistoryList.innerHTML = '';
        conversations.forEach(conv => {
          const item = document.createElement('div'); const isActive = conv.id === currentConversationId;
          item.className = `sidebar-item group relative ${isActive ? 'active' : ''} rounded-lg px-3 py-3 cursor-pointer transition-all`;
          item.innerHTML = `
            <div class="flex flex-col pr-8" onclick="loadConversation('${conv.id}')">
              <p class="text-sm ${isActive ? 'text-slate-200' : 'text-slate-400'} truncate font-medium">${conv.title}</p>
            </div>
            <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
              <button onclick="event.stopPropagation(); renameConversation('${conv.id}', '${conv.title.replace(/'/g, "\\'")}')" class="p-1 hover:text-white text-slate-500" title="Rename">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2"/></svg>
              </button>
              <button onclick="event.stopPropagation(); deleteConversation('${conv.id}')" class="p-1 hover:text-red-400 text-slate-500" title="Delete">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg>
              </button>
            </div>`;
          chatHistoryList.appendChild(item);
        });
      } catch (e) {}
    }

    async function deleteConversation(id) {
      if (!confirm("Are you sure?")) return;
      try {
        const response = await fetch(`/conversations/${id}`, { method: 'DELETE' });
        if (response.ok) {
          if (currentConversationId === id) document.getElementById('new-chat-btn').click();
          else loadChatHistory();
        }
      } catch (e) {}
    }

    async function renameConversation(id, currentTitle) {
      const newTitle = prompt("New title:", currentTitle);
      if (!newTitle || newTitle === currentTitle) return;
      try {
        await fetch(`/conversations/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: newTitle })
        });
        loadChatHistory();
      } catch (e) {}
    }

    async function loadConversation(id) {
      try {
        const response = await fetch(`/conversations/${id}`); const data = await response.json();
        currentConversationId = id; conversationHistory = data.history; chatStarted = true;
        welcomeContainer.classList.add('hidden'); chatContainer.classList.remove('hidden'); inputArea.classList.remove('hidden');
        messagesContainer.innerHTML = ''; data.messages.forEach(msg => addMessage(msg.role, msg.content));
        loadChatHistory(); chatContainer.scrollTop = chatContainer.scrollHeight;
      } catch (e) {}
    }

    async function sendMessage(text) {
      if (!text) return;
      if (!chatStarted) { chatStarted = true; welcomeContainer.classList.add('hidden'); chatContainer.classList.remove('hidden'); inputArea.classList.remove('hidden'); }
      addMessage('user', text); messageInput.value = ''; messageInputWelcome.value = '';
      updateButtonState(messageInput, 'main-action-btn');
      updateButtonState(messageInputWelcome, 'main-action-btn-welcome');
      const aiDiv = addMessage('assistant', ''); const aiContent = aiDiv.querySelector('.content-para');
      aiDiv.querySelector('.typing-placeholder').classList.remove('hidden');
      try {
        const response = await fetch('/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: text, history: conversationHistory, conversation_id: currentConversationId }) });
        const reader = response.body.getReader(); const decoder = new TextDecoder(); let full = "";
        while (true) {
          const { value, done } = await reader.read(); if (done) break;
          const lines = decoder.decode(value).split('\n');
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = JSON.parse(line.slice(6));
              if (data.token) { aiDiv.querySelector('.typing-placeholder').classList.add('hidden'); full += data.token; aiContent.textContent = full; chatContainer.scrollTop = chatContainer.scrollHeight; }
              if (data.done) { conversationHistory = data.history; currentConversationId = data.conversation_id; loadChatHistory(); }
            }
          }
        }
      } catch (e) { aiContent.textContent = "Error."; }
    }

    function addMessage(role, content) {
      const div = document.createElement('div'); div.className = `flex gap-4 message-animate ${role === 'user' ? 'flex-row-reverse' : ''}`;
      div.innerHTML = `
        <div class="w-9 h-9 flex items-center justify-center shrink-0">
          ${role==='user' ? '<div class="w-full h-full rounded-full bg-blue-600 flex items-center justify-center text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke-width="2"/></svg></div>' : '<img src="/assets/logo.png" class="w-full h-full object-contain rounded-lg">'}
        </div>
        <div class="max-w-[80%] ${role==='user' ? 'message-user-liquid' : 'message-ai-liquid'} rounded-2xl px-5 py-3 border border-white/10">
          <p class="content-para text-sm leading-relaxed whitespace-pre-wrap">${content}</p>
          <div class="typing-placeholder hidden mt-2 flex gap-1 items-center">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>`;
      messagesContainer.appendChild(div); chatContainer.scrollTop = chatContainer.scrollHeight; return div;
    }

    function startDictation(inputId, btnId) {
        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Recognition) { alert("Tu navegador no soporta dictado de voz."); return; }
        const recognition = new Recognition();
        recognition.lang = 'es-ES';
        const input = document.getElementById(inputId);
        const micBtn = document.getElementById(btnId);
        
        recognition.onstart = () => { micBtn.classList.add('mic-active'); };
        recognition.onresult = (e) => {
            const transcript = e.results[0][0].transcript;
            input.value += (input.value ? ' ' : '') + transcript;
            input.dispatchEvent(new Event('input'));
        };
        recognition.onend = () => { micBtn.classList.remove('mic-active'); };
        recognition.start();
    }

    document.getElementById('mic-btn').addEventListener('click', () => startDictation('message-input', 'mic-btn'));
    document.getElementById('mic-btn-welcome').addEventListener('click', () => startDictation('message-input-welcome', 'mic-btn-welcome'));

    function handleFormSubmit(e, inputId, btnId) {
        e.preventDefault();
        const input = document.getElementById(inputId);
        const btn = document.getElementById(btnId);
        if (btn.dataset.mode === 'voice') {
            toggleVoiceMode(true);
        } else {
            sendMessage(input.value.trim());
        }
    }

    chatForm.addEventListener('submit', e => handleFormSubmit(e, 'message-input', 'main-action-btn'));
    chatFormWelcome.addEventListener('submit', e => handleFormSubmit(e, 'message-input-welcome', 'main-action-btn-welcome'));
    
    // Sidebar
    let sidebarOpen = false;
    function updateSidebar() { sidebar.style.marginLeft = sidebarOpen ? '0' : '-288px'; document.getElementById('open-sidebar-btn').style.opacity = sidebarOpen ? '0' : '1'; }
    document.getElementById('toggle-sidebar').addEventListener('click', () => { sidebarOpen = false; updateSidebar(); });
    document.getElementById('open-sidebar-btn').addEventListener('click', () => { sidebarOpen = true; updateSidebar(); });
    document.getElementById('new-chat-btn').addEventListener('click', () => { conversationHistory = ""; currentConversationId = null; messagesContainer.innerHTML = ''; chatStarted = false; welcomeContainer.classList.remove('hidden'); chatContainer.classList.add('hidden'); inputArea.classList.add('hidden'); loadChatHistory(); });

    // Textarea auto-resize & Button Toggle
    [ {in: 'message-input', btn: 'main-action-btn'}, {in: 'message-input-welcome', btn: 'main-action-btn-welcome'} ].forEach(pair => {
      const input = document.getElementById(pair.in);
      updateButtonState(input, pair.btn);
      input.addEventListener('input', () => { 
        input.style.height = 'auto'; input.style.height = Math.min(input.scrollHeight, 200) + 'px';
        updateButtonState(input, pair.btn);
      });
      input.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); input.closest('form').dispatchEvent(new Event('submit')); } });
    });

    loadChatHistory();
  </script>
 </body>
</html>