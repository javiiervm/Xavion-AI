<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xavion AI</title>
  <link rel="icon" type="image/png" href="/assets/logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; }
    * { font-family: 'Plus Jakarta Sans', sans-serif; }
    .gradient-bg { background: linear-gradient(180deg, #FF9F60 0%, #FF4060 35%, #FFB6C1 50%, #9900CC 65%, #002080 100%); }
    .gradient-text {
      background: linear-gradient(135deg, #FF9F60 0%, #FF4060 35%, #9900CC 65%, #002080 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      padding-bottom: 0.1em;
    }
    .gradient-border {
      position: relative;
      background: linear-gradient(135deg, rgba(255,159,96,0.1), rgba(153,0,204,0.1));
    }
    .gradient-border::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg, #FF9F60, #FF4060, #9900CC, #002080);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }
    .message-gradient { background: linear-gradient(135deg, #9900CC 0%, #002080 100%); }
    .user-message-gradient { background: linear-gradient(135deg, #FF9F60 0%, #FF4060 100%); }
    .glow-effect { box-shadow: 0 0 40px rgba(153, 0, 204, 0.15), 0 0 80px rgba(0, 32, 128, 0.1); }
    .input-glow:focus { box-shadow: 0 0 0 3px rgba(153, 0, 204, 0.2), 0 0 20px rgba(255, 64, 96, 0.15); }
    .send-btn {
      background: linear-gradient(135deg, #FF9F60 0%, #FF4060 50%, #9900CC 100%);
      background-size: 200% 200%;
      animation: gradientShift 3s ease infinite;
    }
    .send-btn:hover { background-size: 100% 100%; transform: scale(1.05); }
    @keyframes gradientShift { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message-animate { animation: fadeInUp 0.3s ease-out; }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }
    .typing-dot { animation: typing 1s ease-in-out infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }
    .scrollbar-custom::-webkit-scrollbar { width: 6px; }
    .scrollbar-custom::-webkit-scrollbar-track { background: rgba(153, 0, 204, 0.05); border-radius: 3px; }
    .scrollbar-custom::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #FF4060, #9900CC); border-radius: 3px; }
    .logo-icon { background: linear-gradient(180deg, #FF9F60 0%, #FF4060 35%, #FFB6C1 50%, #9900CC 65%, #002080 100%); }
    .sidebar-item:hover { background: linear-gradient(90deg, rgba(153,0,204,0.1), transparent); }
    .sidebar-item.active { background: linear-gradient(90deg, rgba(153,0,204,0.15), transparent); border-left: 3px solid #9900CC; }
  </style>
 </head>
 <body class="h-full bg-slate-950 text-white overflow-hidden">
  <div class="h-full w-full flex relative">
   <!-- Sidebar -->
   <aside id="sidebar" class="w-72 bg-slate-900/80 border-r border-slate-800 flex flex-col h-full shrink-0 transition-all duration-300 ease-in-out" style="margin-left: -288px;">
    <div class="p-5 border-b border-slate-800 flex items-center justify-between">
     <div class="flex items-center">
      <img src="/assets/logo_full.png" alt="Xavion AI" class="h-10 w-auto object-contain">
     </div>
     <button id="toggle-sidebar" class="p-2.5 rounded-lg bg-slate-800/50 hover:bg-slate-700 border border-slate-700 transition-all duration-300">
      <svg id="toggle-icon" class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
     </button>
    </div>
    <div class="p-4">
      <button id="new-chat-btn" class="w-full py-3 px-4 rounded-xl gradient-border text-white font-medium flex items-center justify-center gap-2 hover:bg-slate-800/50 transition-all duration-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> New conversation
      </button>
    </div>
    <div class="flex-1 overflow-y-auto scrollbar-custom px-3">
     <!-- Settings removed as requested -->
    </div>
   </aside>

   <!-- Toggle Button (visible when sidebar is closed) -->
   <button id="open-sidebar-btn" class="fixed left-4 top-4 p-2.5 rounded-lg bg-slate-900/80 hover:bg-slate-800 border border-slate-800 transition-all duration-300 opacity-100 pointer-events-auto" style="z-index: 40;">
    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
   </button>

   <!-- Main Chat Area -->
   <main class="flex-1 flex flex-col h-full bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950 overflow-hidden">
    <!-- Welcome View -->
    <div id="welcome-container" class="flex-1 flex flex-col items-center justify-center px-4">
     <div class="text-center mb-12">
      <div class="w-72 h-72 mx-auto mb-2">
       <img src="/assets/logo.png" alt="Xavion Logo" class="w-full h-full object-contain rounded-2xl">
      </div>
      <h1 id="welcome-title" class="text-4xl font-bold gradient-text mb-3">How can I help you today?</h1>
     </div>
     <form id="chat-form-welcome" class="relative w-full max-w-2xl">
      <div class="relative gradient-border rounded-[2rem] overflow-hidden glow-effect">
        <textarea id="message-input-welcome" rows="1" placeholder="Type your message..." class="w-full bg-slate-900/90 text-white placeholder-slate-500 px-6 py-4 pr-14 resize-none focus:outline-none input-glow rounded-[2rem] text-base" style="max-height: 200px;"></textarea>
        <button type="submit" class="send-btn absolute right-2 bottom-2 w-11 h-11 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </button>
      </div>
     </form>
    </div>

    <!-- Chat Messages -->
    <div id="chat-container" class="flex-1 overflow-y-auto scrollbar-custom px-4 py-6 hidden">
     <div class="max-w-3xl mx-auto space-y-6">
      <div id="messages" class="space-y-6"></div>
     </div>
    </div>

    <!-- Input Area -->
    <div id="input-area" class="border-t border-slate-800/50 bg-slate-900/50 backdrop-blur-sm px-4 py-4 hidden">
     <div class="max-w-3xl mx-auto">
      <form id="chat-form" class="relative">
       <div class="relative gradient-border rounded-[2rem] overflow-hidden glow-effect">
         <textarea id="message-input" rows="1" placeholder="Type your message..." class="w-full bg-slate-900/90 text-white placeholder-slate-500 px-6 py-4 pr-14 resize-none focus:outline-none input-glow rounded-[2rem] text-base" style="max-height: 200px;"></textarea>
         <button type="submit" id="send-btn" class="send-btn absolute right-2 bottom-2 w-11 h-11 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg">
           <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
         </button>
       </div>
      </form>
     </div>
    </div>
   </main>
  </div>

  <script>
    let conversationHistory = "";
    let chatStarted = false;

    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatFormWelcome = document.getElementById('chat-form-welcome');
    const messageInputWelcome = document.getElementById('message-input-welcome');
    const messagesContainer = document.getElementById('messages');
    const chatContainer = document.getElementById('chat-container');
    const inputArea = document.getElementById('input-area');
    const welcomeContainer = document.getElementById('welcome-container');
    const welcomeTitle = document.getElementById('welcome-title');

    const welcomeMessages = [
      "How can I help you today?",
      "What's on your mind?",
      "Need help with something?",
      "Let's build something amazing.",
      "Ready to assist you!",
      "What can I do for you today?",
      "Ask me anything!"
    ];

    function setRandomWelcomeMessage() {
      const randomIndex = Math.floor(Math.random() * welcomeMessages.length);
      welcomeTitle.textContent = welcomeMessages[randomIndex];
    }

    // Set initial welcome message
    setRandomWelcomeMessage();

    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
    }

    [messageInput, messageInputWelcome].forEach(input => {
      input.addEventListener('input', function() { autoResizeTextarea(this); });
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.closest('form').dispatchEvent(new Event('submit'));
        }
      });
    });

    async function sendMessage(text) {
      if (!text) return;
      
      if (!chatStarted) {
        chatStarted = true;
        welcomeContainer.classList.add('hidden');
        chatContainer.classList.remove('hidden');
        inputArea.classList.remove('hidden');
      }

      addMessage('user', text);
      messageInput.value = '';
      messageInputWelcome.value = '';
      messageInput.style.height = 'auto';
      
      const aiMessageDiv = addMessage('assistant', '');
      const aiContentPara = aiMessageDiv.querySelector('.content-para');
      showTypingIndicator(aiMessageDiv);

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: text,
            history: conversationHistory,
            mode: "auto",
            debug: false
          })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = "";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          
          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = JSON.parse(line.slice(6));
              if (data.token) {
                hideTypingIndicator(aiMessageDiv);
                fullResponse += data.token;
                aiContentPara.textContent = fullResponse;
                chatContainer.scrollTop = chatContainer.scrollHeight;
              } else if (data.done) {
                conversationHistory = data.history;
              }
            }
          }
        }
      } catch (error) {
        console.error("Error:", error);
        hideTypingIndicator(aiMessageDiv);
        aiContentPara.textContent = "Error connecting to the server.";
      }
    }

    chatForm.addEventListener('submit', e => { e.preventDefault(); sendMessage(messageInput.value.trim()); });
    chatFormWelcome.addEventListener('submit', e => { e.preventDefault(); sendMessage(messageInputWelcome.value.trim()); });

    function addMessage(role, content) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex gap-4 message-animate ${role === 'user' ? 'flex-row-reverse' : ''}`;
      
      const avatar = role === 'user' 
        ? `<div class="w-9 h-9 rounded-full bg-gradient-to-br from-violet-500 to-indigo-600 flex items-center justify-center shrink-0">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
           </div>`
        : `<div class="w-11 h-11 flex items-center justify-center shrink-0">
            <img src="/assets/logo.png" alt="Xavion" class="w-full h-full object-contain rounded-lg">
           </div>`;
      
      const bubbleClass = role === 'user' ? 'user-message-gradient text-white' : 'bg-slate-800/80 text-slate-200';
      
      messageDiv.innerHTML = `
        ${avatar}
        <div class="max-w-[80%] ${bubbleClass} rounded-2xl px-5 py-3 shadow-lg">
          <p class="content-para text-sm leading-relaxed whitespace-pre-wrap">${content}</p>
          <div class="typing-placeholder hidden mt-2">
            <div class="flex gap-1.5">
              <div class="w-1.5 h-1.5 rounded-full bg-violet-400 typing-dot"></div>
              <div class="w-1.5 h-1.5 rounded-full bg-pink-400 typing-dot"></div>
              <div class="w-1.5 h-1.5 rounded-full bg-orange-400 typing-dot"></div>
            </div>
          </div>
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return messageDiv;
    }

    function showTypingIndicator(messageDiv) {
      const indicator = messageDiv.querySelector('.typing-placeholder');
      indicator.classList.remove('hidden');
      
      // Also ensure the avatar is the logo if it's the first message
      const avatarContainer = messageDiv.querySelector('.shrink-0');
      if (avatarContainer && !avatarContainer.querySelector('img')) {
          avatarContainer.innerHTML = `<img src="/assets/logo.png" alt="Xavion" class="w-full h-full object-contain rounded-lg">`;
          avatarContainer.className = "w-11 h-11 flex items-center justify-center shrink-0";
      }
    }

    function hideTypingIndicator(messageDiv) {
      messageDiv.querySelector('.typing-placeholder').classList.add('hidden');
    }

    // Sidebar Logic
    let sidebarOpen = false;
    const toggleBtn = document.getElementById('toggle-sidebar');
    const openBtn = document.getElementById('open-sidebar-btn');
    const sidebar = document.getElementById('sidebar');
    const toggleIcon = document.getElementById('toggle-icon');

    function updateSidebarState() {
      if (sidebarOpen) {
        sidebar.style.marginLeft = '0';
        toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>';
        openBtn.style.opacity = '0';
        openBtn.style.pointerEvents = 'none';
      } else {
        sidebar.style.marginLeft = '-288px';
        toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>';
        openBtn.style.opacity = '1';
        openBtn.style.pointerEvents = 'auto';
      }
    }

    // Initialize state
    updateSidebarState();

    toggleBtn.addEventListener('click', () => { sidebarOpen = !sidebarOpen; updateSidebarState(); });
    openBtn.addEventListener('click', () => { sidebarOpen = true; updateSidebarState(); });

    document.getElementById('new-chat-btn').addEventListener('click', () => {
      conversationHistory = "";
      messagesContainer.innerHTML = '';
      chatStarted = false;
      setRandomWelcomeMessage();
      welcomeContainer.classList.remove('hidden');
      chatContainer.classList.add('hidden');
      inputArea.classList.add('hidden');
    });
  </script>
 </body>
</html>
